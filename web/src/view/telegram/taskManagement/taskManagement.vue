<template>
    <div>
        <div class="card" style="margin-bottom: 5px">
            <el-input style="width: 240px; margin-right: 10px" v-model="data.name" placeholder="ËØ∑ËæìÂÖ•ÂêçÁß∞ÊêúÁ¥¢"
                prefix-icon="Search"></el-input>
            <el-select style="width: 15%" v-model="data.form.userName" placeholder="ËØ∑ÈÄâÊã©ÂàÜÁªÑÂêçÊêúÁ¥¢"
                @change="handleGroupChange">
                <el-option v-for="group in data.tableDataGroup" :key="group.id" :label="group.label"
                    :value="group.groupName" />
            </el-select>
            <el-button type="primary" @click="load">Êü• ËØ¢</el-button>
            <el-button type="warning" @click="reset">Èáç ÁΩÆ</el-button>
        </div>
        <div class="card" style="margin-bottom: 5px">
            <el-button type="primary" @click="handleAdd">
                <ChatDotRound style="width: 1em; height: 1em; margin-right: 3px" />ÊâπÈáèÂèëÈÄÅ
            </el-button>
            <el-button type="primary" @click="delAll">
                <Link style="width: 1em; height: 1em; margin-right: 3px" />ÊâπÈáèËΩ¨Âèë
            </el-button>
            <el-button type="primary" @click="groupAll">
                <ChatDotRound style="width: 1em; height: 1em; margin-right: 3px" />ÊâπÈáèÁßÅËÅä
            </el-button>
            <el-button type="primary" @click="batchUpdateOnline(true)">
                <VideoPlay style="width: 1em; height: 1em; margin-right: 3px" />ÂêØÂä®
            </el-button>
            <el-button type="primary" @click="batchUpdateOnline(false)">
                <VideoPause style="width: 1em; height: 1em; margin-right: 3px" />ÊöÇÂÅú
            </el-button>
            <el-button type="danger" plain @click="batchUpdateOnline(false)">
                <Delete style="width: 1em; height: 1em; margin-right: 3px" />Âà†Èô§
            </el-button>
            <el-button type="primary" plain @click="batchUpdateOnline(false)">ÈáçÊñ∞Á≠õÈÄâ</el-button>
        </div>
        <div class="card">
            <el-table :data="data.tableData" @selection-change="handleSelectionChange" stripe>
                <el-table-column type="selection" width="55" />
                <el-table-column prop="name" label="Ë¥¶Âè∑" show-overflow-tooltip />
                <el-table-column prop="phone" label="‰ªªÂä°ÂêçÁß∞" show-overflow-tooltip />
                <el-table-column prop="username" label="‰ªªÂä°Áä∂ÊÄÅ" show-overflow-tooltip />
                <el-table-column prop="groupNumber" label="‰ªªÁõÆÊ†áÊï∞Èáè" show-overflow-tooltip />
                <el-table-column prop="tag" label="ÊàêÂäüÊï∞Èáè" show-overflow-tooltip>
                    <template #default="scope">
                        {{ scope.row.tag }}
                    </template>
                </el-table-column>
                <el-table-column prop="is_premium" label="Âçï‰∏™Èó¥Èöî" show-overflow-tooltip>
                    <template #default="{ row }">
                        {{ row.is_premium ? 'ÊòØ' : 'Âê¶' }}
                    </template>
                </el-table-column>
                <el-table-column prop="online" label="È¢ÑËÆ°ËÄóÊó∂">
                    <template #default="{ row }">
                        <el-switch v-model="row.online" inline-prompt :active-value="true" :inactive-value="false"
                            active-text="Âú®Á∫ø" inactive-text="Á¶ªÁ∫ø" @change="handleOnlineChange(row)"
                            show-overflow-tooltip />
                    </template>
                </el-table-column>
                <el-table-column prop="is_blocked" label="Âæ™ÁéØÈó¥Èöî">
                    <template #default="{ row }">
                        {{ {
                            true: 'üî¥ ÂºÇÂ∏∏',
                            false: 'üü¢ Ê≠£Â∏∏'
                        }[row.is_blocked] || '‚ö™ Áä∂ÊÄÅÂºÇÂ∏∏' }}
                    </template>
                </el-table-column>
                <el-table-column prop="server" label="Â∑≤Âæ™ÁéØ" show-overflow-tooltip />
                <el-table-column prop="proxy" label="‰ª£ÁêÜIP" show-overflow-tooltip />
                <el-table-column prop="loginMethod" label="ÂàõÂª∫Êó∂Èó¥" show-overflow-tooltip>
                    <template #default="{ row }">
                        ÂçèËÆÆÂè∑
                    </template>
                </el-table-column>
                <el-table-column prop="created_at" label="ÂàõÂª∫Êó∂Èó¥" show-overflow-tooltip />
                <el-table-column prop="deptName" label="Êìç‰Ωú">
                    <template #default="scope">
                        <el-button @click="handleUpdata(scope.row)" type="primary" :icon="Edit" circle></el-button>
                        <el-button @click="del(scope.row.phone)" type="danger" :icon="Delete" circle></el-button>
                    </template>
                </el-table-column>
            </el-table>
            <div style="margin-top: 15px">
                <el-pagination @change="load" v-model:current-page="data.pageNum" v-model:page-size="data.pageSize"
                    :page-sizes="[5, 10, 15, 20,100]" background layout="total,sizes,prev,pager,next,jumper"
                    :total="data.total" />
            </div>
        </div>




        <!-- ÊâπÈáèÂèëÈÄÅ  Ê®°ÊÄÅÊ°Ü -->
        <el-drawer v-model="data.formVisible" :title="data.titleName" direction="rtl" size="50%">
            <el-form-item label="Ë¥¶Âè∑" required>
                <el-select v-model="data.form.userName" multiple placeholder="ËØ∑ÈÄâÊã©Ë¥¶Âè∑">
                    <el-option v-for="group in data.tableDataGroup" :key="group.id" :label="group.label"
                        :value="group.groupName" />
                </el-select>
            </el-form-item>

            <el-form-item label="ÂèëÈÄÅÁõÆÊ†á" required>
                <el-radio-group v-model="data.target">
                    <el-radio label="Áî®Êà∑">Áî®Êà∑</el-radio>
                    <el-radio label="Áæ§ÁªÑ">Áæ§ÁªÑ</el-radio>
                </el-radio-group>
            </el-form-item>
            <el-form-item label="Ê∂àÊÅØÂõæÁâá">
                <el-upload class="upload-demo" action="#" :auto-upload="false" :show-file-list="true"
                    list-type="picture-card">
                    <el-icon>
                        <Plus />
                    </el-icon>
                </el-upload>
            </el-form-item>

   

                <el-form-item label="Ê∂àÊÅØÂÜÖÂÆπ" required>
                    <div v-for="(msg, index) in data.messages" :key="index"
                        style="display: flex; align-items: flex-start; margin-bottom: 12px;">
                        <el-input v-model="data.messages[index]" type="textarea" :rows="3" placeholder="ËØ∑ËæìÂÖ•ÂÜÖÂÆπ"
                            maxlength="4090" show-word-limit style="flex: 1;" />
                        <el-button type="danger" icon="Delete" size="small" @click="removeMessage(index)"
                            style="margin-left: 10px;" :disabled="data.messages.length === 1">
                            Âà†Èô§
                        </el-button>
                    </div>

                    <el-button type="primary" plain size="small" @click="addMessage">
                        Ê∑ªÂä†‰∏ÄÊù°Ê∂àÊÅØ
                    </el-button>
                </el-form-item>

            <el-form-item label="ÈìæÊé•È¢ÑËßà" required>
                <el-switch v-model="data.preview" />
            </el-form-item>

            <el-form-item label="Ê∂àÊÅØÂ∞æÁºÄ" required>
                <el-radio-group v-model="data.suffix">
                    <el-radio label="Ë°®ÊÉÖ">Ë°®ÊÉÖ</el-radio>
                    <el-radio label="Â≠óÊØç">Â≠óÊØç</el-radio>
                    <el-radio label="ÂÖ≥Èó≠">ÂÖ≥Èó≠</el-radio>
                </el-radio-group>
            </el-form-item>

            <el-form-item label="ÂèëÈÄÅÊñπÂºè" required>
                <el-radio-group v-model="data.sendType">
                    <el-radio label="ÂçïÊ¨°ÂèëÈÄÅ">ÂçïÊ¨°ÂèëÈÄÅ</el-radio>
                    <el-radio label="Âæ™ÁéØÂèëÈÄÅ">Âæ™ÁéØÂèëÈÄÅ</el-radio>
                </el-radio-group>
            </el-form-item>

            <el-form-item label="Âçï‰∏™Èó¥Èöî">
                <el-input-number v-model="data.intervalMin" :min="0" /> ~
                <el-input-number v-model="data.intervalMax" :min="1" />
                <span style="margin-left: 10px;">Áßí</span>
            </el-form-item>

            <el-form-item label="Âæ™ÁéØÈó¥Èöî">
                <el-input-number v-model="data.loopMin" :min="1" /> ~
                <el-input-number v-model="data.loopMax" :min="data.loopMin + 1" />
                <span style="margin-left: 10px;">ÂàÜÈíü</span>
            </el-form-item>

            <el-form-item label="‰ºëÊÅØÊó∂Èó¥ÊÆµ">
                <el-date-picker v-model="data.restTime" type="datetimerange" start-placeholder="ÂºÄÂßãÊó∂Èó¥"
                    end-placeholder="ÁªìÊùüÊó∂Èó¥" style="width: 100%;" />
            </el-form-item>

            <el-form-item label="ÂÅúÊ≠¢Êó•Êúü">
                <el-date-picker v-model="data.stopDate" type="date" placeholder="ËØ∑ÈÄâÊã©Êó•Êúü" />
            </el-form-item>

            <el-form-item>
                <el-button type="primary" @click="submit">Êèê‰∫§</el-button>
                <el-button @click="cancel">ÂèñÊ∂à</el-button>
            </el-form-item>
        </el-drawer>

        <!-- ÊâπÈáèÂèëÈÄÅ  Ê®°ÊÄÅÊ°Ü ÁªìÊùü -->

        <el-dialog v-model="data.personalData" width="500" destroy-on-close>

            <el-tabs v-model="activeTab">
                <!-- È°µÈù¢1 -->
                <el-tab-pane label="ÁºñËæëÁîµÊä•‰∏™‰∫∫‰ø°ÊÅØ" name="page1">
                    <br>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="width: 60px; text-align: right; margin-right: 10px;">Áî®Êà∑Âêç:</span>
                        <el-input v-model="data.personal_details" :value="data.form.username" placeholder="Áî®Êà∑Âêç"
                            style="width: 80%;" />
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="width: 60px; text-align: right; margin-right: 10px;">ÂßìÊ∞è:</span>
                        <el-input v-model="data.personal_details" value="" placeholder="ÂßìÊ∞è" style="width: 80%;" />
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="width: 60px; text-align: right; margin-right: 10px;">ÂêçÁß∞:</span>
                        <el-input v-model="data.personal_details" value="" placeholder="ÂêçÁß∞" style="width: 80%;" />
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="width: 60px; text-align: right; margin-right: 10px;">‰∏™‰∫∫ÁÆÄ‰ªã:</span>
                        <el-input v-model="data.personal_details" value="" placeholder="‰∏™‰∫∫ÁÆÄ‰ªã" style="width: 80%;" />
                    </div>

                </el-tab-pane>

                <!-- È°µÈù¢2 -->
                <el-tab-pane label="‰øÆÊîπÁîµÊä•ÂàÜÁªÑ" name="page2">
                    <br>
                    <el-input v-model="data.individual_grouping" value="" placeholder="Âπ¥ÈæÑ" />
                </el-tab-pane>

                <!-- È°µÈù¢3 -->
                <el-tab-pane label="‰øÆÊîπÈªòËÆ§" name="page3">
                    <br>
                    <el-input v-model="data.form.address" placeholder="Âú∞ÂùÄ" />
                </el-tab-pane>
            </el-tabs>

            <template #footer>
                <div class="dialog-footer">
                    <el-button type="warning" @click="savePersonalInformation">Á°ÆËÆ§</el-button>
                    <el-button type="primary" @click="data.personalData = false">ÂèñÊ∂à</el-button>
                </div>
            </template>
        </el-dialog>
        <el-dialog :title="data.titleName" v-model="data.formGroup" width="500" destroy-on-close>

            <br>
            ÂàÜÁªÑ: <el-select style="width: 50%" v-model="data.form.groupName_list" placeholder="ËØ∑ÈÄâÊã©ÂàÜÁªÑÂêçÊêúÁ¥¢"
                @change="handleGroupList">
                <el-option v-for="group in data.tableDataGroup" :key="group.id" :label="group.label"
                    :value="group.groupName" />
            </el-select>
            <template #footer>
                <div class="dialog-footer">
                    <el-button type="warning" @click="setAllGroup">Á°ÆËÆ§</el-button>
                    <el-button type="primary" @click="data.formGroup = false">ÂèñÊ∂à</el-button>
                </div>
            </template>
        </el-dialog>

    </div>
</template>

<script setup lang="ts">
import { reactive, ref, onMounted } from "vue";
import request from "@/utils/request.js";
import { ElMessage, ElMessageBox } from "element-plus";
import { Edit, Delete, UploadFilled } from "@element-plus/icons-vue";
import type { UploadInstance } from 'element-plus'
import { useUserStore } from '@/pinia/modules/user'

const activeTab = ref('page1')
// Êñá‰ª∂ÂàóË°®ÔºàElement Plus Áî®Êù•ÊòæÁ§∫Ôºâ
const userStore = useUserStore()
const uploadFileList = ref([]);

const uploadRef = ref<UploadInstance>()
const fileRawList = ref<File[]>([]);

const data = reactive({
    name: null,
    tableData: [
    ],
    tableDataGroup: [

    ],
    selectedGroupId: null,
    pageNum: 1,
    pageSize: 10,
    total: 0,
    formVisible: false,
    personalData: false,
    form: {// ÂÖ∂‰ªñË°®ÂçïÂ≠óÊÆµ
        username: userStore.userInfo.nickName,
        // Â≠òÂÇ®‰∏ä‰º†ÁöÑÊñá‰ª∂
        session_files: []
    },
    personal_details: {},
    individual_grouping: {},
    listGroupId: null,
    formGroup: false,
    Ids: [],
    rules: {
        username: [
            { required: true, message: 'ËØ∑ËæìÂÖ•Ë¥¶Âè∑', trigger: 'blur' },
        ],
        name: [
            { required: true, message: 'ËØ∑ËæìÂÖ•ÂßìÂêç', trigger: 'blur' },
            { min: 2, max: 5, message: 'ÈïøÂ∫¶Âú® 2 Âà∞ 5 ‰∏™Â≠óÁ¨¶', trigger: 'blur' }
        ],
        no: [
            { required: true, message: 'ËØ∑ËæìÂÖ•Â∑•Âè∑', trigger: 'blur' }
        ]
    },
    titleName: 'Ê∑ªÂä†Ë¥¶Âè∑',
    deptList: [],

    //ÊµãËØï
    accounts: [],
    target: 'Áæ§ÁªÑ',
    messages: [''], // ÈªòËÆ§Êúâ‰∏ÄÊù°
    preview: true,
    suffix: 'Â≠óÊØç',
    sendType: 'ÂçïÊ¨°ÂèëÈÄÅ',
    intervalMin: 0,
    intervalMax: 60,
    loopMin: 5,
    loopMax: 10,
    restTime: [],
    stopDate: null

}
)
//
const addMessage = () => {
  data.messages.push('')
}

const removeMessage = (index) => {
  if (data.messages.length > 1) {
    data.messages.splice(index, 1)
  }
}

const submit = () => {
    console.log('Êèê‰∫§Ë°®Âçï:', data.value)
}


const cancel = () => {
    console.log('ÂèñÊ∂àÊìç‰Ωú')
}
//
function savePersonalInformation() {
    switch (activeTab.value) {
        case 'page1':
            console.log('‰øùÂ≠ò‰∏™‰∫∫‰ø°ÊÅØ:', data.personal_details)
            // ÊâßË°åÈ°µÈù¢1ÁöÑ‰øùÂ≠òÈÄªËæë
            break

        case 'page2':
            console.log('‰øùÂ≠òÂàÜÁªÑ‰ø°ÊÅØ:', data.individual_grouping)
            // ÊâßË°åÈ°µÈù¢2ÁöÑ‰øùÂ≠òÈÄªËæë
            break

        case 'page3':
            console.log('‰øùÂ≠òÂú∞ÂùÄ‰ø°ÊÅØ:', data.form.address)
            // ÊâßË°åÈ°µÈù¢3ÁöÑ‰øùÂ≠òÈÄªËæë
            break

        default:
            console.warn('Êú™Áü•È°µÈù¢')
    }

    // ÂèØÈÄâÔºöÂÖ≥Èó≠ÂØπËØùÊ°Ü
    data.personalData = false
}
function handleGroupChange(groupName) {
    const group = data.tableDataGroup.find(g => g.groupName === groupName)
    data.selectedGroupId = group ? group.id : null
    console.log('ÂΩìÂâçÂàÜÁªÑIDÔºö', data.selectedGroupId)
}

function handleGroupList(groupName) {
    const group = data.tableDataGroup.find(g => g.groupName === groupName)
    data.listGroupId = group ? group.id : null
    console.log('ÂΩìÂâçÂàÜÁªÑIDÔºö', data.selectedGroupId)
} const handleOnlineChange = (row) => {
    console.log('ÂΩìÂâçË°åÊï∞ÊçÆÔºö', row)
    console.log('ÂΩìÂâç online Áä∂ÊÄÅÔºö', row.online)
    const phone = [row.phone]


    if (row.online == 1) {

        console.log('ÁôªÂÖ•')

        request.post("/api/sign_in", { phone: phone, proxy: "", server: row.server })
            .then(res => {
                load()

            })
        return
    }
    if (row.online == 0) {
        console.log('ÁôªÂá∫')
        console.log(row.phone)
        request.post("/api/sign_out", { phone: phone }).then(res => {
            load()

        })
    }

    //   // Â¶ÇÊûú‰Ω†Ë¶ÅÂèëÈÄÅËØ∑Ê±ÇÊõ¥Êñ∞Ëøô‰∏™Áä∂ÊÄÅÔºö
    //   request.post('/api/update_online_status', { 
    //     id: row.id,
    //     online: row.online
    //   }).then(res => {
    //     ElMessage.success('Êõ¥Êñ∞ÊàêÂäü')
    //   }).catch(err => {
    //     ElMessage.error('Êõ¥Êñ∞Â§±Ë¥•')
    //   })
}
// ÊØèÊ¨°Ê∑ªÂä†Êñá‰ª∂Êó∂Ëß¶Âèë
const clearUploadFiles = () => {
    uploadRef.value?.clearFiles();      // Ê∏ÖÁ©∫ el-upload ÊòæÁ§∫ÁöÑÊñá‰ª∂
    fileRawList.value = [];             // Ê∏ÖÁ©∫‰Ω†‰øùÂ≠òÁöÑÊñá‰ª∂ÂèòÈáè
    uploadFileList.value = [];          // Ê∏ÖÁ©∫ UI Êñá‰ª∂ÂàóË°®ÔºàÊòæÁ§∫Áî®Ôºâ
};
const handleFileChange = (uploadFile, uploadFiles) => {
    fileRawList.value = uploadFiles.map(f => f.raw); // ËøôÈáåÂ≠òÂÇ®ÂéüÂßãÊñá‰ª∂
    uploadFileList.value = uploadFiles; // ÊòæÁ§∫Âú®ÂàóË°®‰∏≠
    // Ëá™Âä®ËøáÊª§Êó†ÊïàÊñá‰ª∂
    console.log('‰∏ä‰º†Êñá‰ª∂', uploadFile, uploadFiles)

    uploadFileList.value = uploadFiles.filter(f => {
        const { isSession, isSizeValid } = validateSessionFile(f.raw)
        return isSession && isSizeValid
    })
    if (uploadFileList.value.length == 0) {
        ElMessage.error(uploadFile.name + 'Êñá‰ª∂‰∏çÁ¨¶ÂêàË¶ÅÊ±Ç')

    }

};
const loadGroupList = () => {
    console.log("ËØ∑Ê±ÇÂèÇÊï∞", { page: data.pageNum, page_size: data.pageSize, user_name: userStore.userInfo.nickName })

    request.post('/api/list_telegram_group', {
        page: data.pageNum,
        page_size: 1000000,
        user_name: userStore.userInfo.nickName,
        group_name: data.groupName
    }).then(res => {


        data.tableDataGroup = res.data.list;
        data.total = res.data.total;

        // console.log("ÂàóË°®Êï∞ÊçÆ", res);

    }).catch(err => {
        console.error('Êé•Âè£ÂºÇÂ∏∏Ôºö', err);
        ElMessage.error('ÊúçÂä°Âô®ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
    });
}

// request.get('/dept/selectAll').then(res => {
//     data.deptList = res.data
// })
// Êñá‰ª∂Á±ªÂûãÈ™åËØÅÊñπÊ≥ï
const validateSessionFile = (file) => {
    // ÂèåÈáçÈ™åËØÅÔºöÊñá‰ª∂ÂêçÂêéÁºÄ + MIMEÁ±ªÂûãÔºàÂèØÈÄâÔºâ
    const isSession = [
        file.name.split('.').pop().toLowerCase() === 'session',      // È™åËØÅÊâ©Â±ïÂêç
        // file.type === 'application/octet-stream'                  // ÂèØÈÄâÈ™åËØÅMIMEÁ±ªÂûã
    ].every(Boolean)

    // Êñá‰ª∂Â§ßÂ∞èÈ™åËØÅÔºà500KBÈôêÂà∂Ôºâ
    const isSizeValid = file.size / 1024 <= 500

    return { isSession, isSizeValid }
}
const beforeUpload = (file) => {
    const { isSession, isSizeValid } = validateSessionFile(file)

    console.log('Êñá‰ª∂Á±ªÂûã', isSession, file)
    if (!isSession) {
        ElMessage.error(`Êñá‰ª∂ [${file.name}] Á±ªÂûã‰∏çÁ¨¶ÂêàË¶ÅÊ±ÇÔºåÂøÖÈ°ª‰∏∫ .session Êñá‰ª∂`)
        console.log('Êñá‰ª∂Á±ªÂûã‰∏çÁ¨¶ÂêàË¶ÅÊ±Ç')
        return false
    }

    if (!isSizeValid) {
        ElMessage.error(`Êñá‰ª∂ [${file.name}] Â§ßÂ∞èË∂ÖËøá500KBÈôêÂà∂`)
        console.log('Êñá‰ª∂Á±ªÂûã‰∏çÁ¨¶ÂêàË¶ÅÊ±Ç1')
        return false
    }

    return true
};

const load = () => {
    console.log("ËØ∑Ê±ÇÂèÇÊï∞", { page: data.pageNum, page_size: data.pageSize, master_username: userStore.userInfo.nickName })

    request.post('/api/get_session', {
        tag: data.selectedGroupId,
        name: data.name,
        page: data.pageNum,
        page_size: data.pageSize,
        master_username: userStore.userInfo.nickName

    }).then(res => {


        data.tableData = res.data.session;
        data.total = res.data.count;

        console.log("ÂàóË°®Êï∞ÊçÆ", res);

    }).catch(err => {
        console.error('Êé•Âè£ÂºÇÂ∏∏Ôºö', err);
        ElMessage.error('ÊúçÂä°Âô®ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
    });
}
onMounted(() => {
    console.log('Ë∞ÉÁî® load ÂâçÁöÑÁî®Êà∑Âêç:', data.form.username);

    loadGroupList()
    load()
})
const reset = () => {
    ``
    data.form.userName = null
    data.name = null
    data.selectedGroupId = null
    load()
}
const handleAdd = () => {
    data.formVisible = true
    data.titleName = 'ÂèëÈÄÅÊ∂àÊÅØ'

}

const add = () => {
    data.titleName = 'Ê∑ªÂä†Ë¥¶Âè∑'
    const formData = new FormData()

    // Ê∑ªÂä†Â§ö‰∏™Êñá‰ª∂ÔºåÂ≠óÊÆµÂêçÁªü‰∏Ä‰∏∫ 'session'ÔºàÂêéÁ´ØÊé•Êî∂Â§öÊñá‰ª∂Â≠óÊÆµÂêç‰∏ÄËá¥Ôºâ
    fileRawList.value.forEach(file => {
        formData.append('session_files[]', file);
    });



    formData.append('master_username', data.form.username);
    console.log(data.form.username);
    // ÊâìÂç∞ formData ÁöÑÈîÆÂÄºÂØπ
    formData.forEach((value, key) => {
        if (value instanceof File) {
            console.log(`key: ${key}, filename: ${value.name}, size: ${value.size}`);
        } else {
            console.log(`key: ${key}, value: ${value}`);
        }
    });
    console.log(formData);
    console.log(data.form);
    try {
        request.post('/api/import_session', formData, {
            headers: {
                'Content-Type': 'multipart/form-data'  // ÂøÖÈ°ªËÆæÁΩÆËØ∑Ê±ÇÂ§¥
            }
        }).then(res => {


            ElMessage.success('‰∏ä‰º†ÊàêÂäü');
            clearUploadFiles();
            data.formVisible = false;

            load()

        })
    } catch (error) {
        ElMessage.error('‰∏ä‰º†Â§±Ë¥•');
        console.error('ÈîôËØØËØ¶ÊÉÖ:', error);
        clearUploadFiles();
        data.formVisible = false
        // load()
        load()
    }

    data.formVisible = false
    // load()

}

const save = () => {

    add()
    // formRef.value.validate(valid => {
    //     if (valid)
    //         data.form.id ? updata() : add()
    // })

}

const del = (phone) => {
    const phonenumber = []
    phonenumber.push(phone)
    ElMessageBox.confirm('Âà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÔºåÁ°ÆÂÆöÂà†Èô§ÂêóÔºü', 'ÊèêÁ§∫', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
    }).then(() => {
        request.post('/api/delete_session',
            { phone: phonenumber }).then(res => {
                if (res.code == 0) {
                    ElMessage.success('Âà†Èô§ÊàêÂäü')
                    load()
                } else {
                    ElMessage.error(res.msg)
                }
            })
    }).catch(() => {
        ElMessage({
            type: 'info',
            message: 'Â∑≤ÂèñÊ∂àÂà†Èô§'
        });
    });

}
const handleUpdata = (row) => {
    data.form = JSON.parse(JSON.stringify(row))
    if (row.online == false) {
        ElMessage.error('Ë¥¶Âè∑Êú™ÁôªÂÖ•Êó†Ê≥ïÁºñËæë')

        return
    }
    data.personalData = true
}
const handleSelectionChange = (rows) => {
    console.log(rows.map(item => item.phone))
    data.Ids = rows.map(item => item.phone)
}

const setAllGroup = () => {
    if (data.listGroupId == null) {
        ElMessage.error('ËØ∑ÈÄâÊã©ÂàÜÁªÑ')
        return
    }

    request.post('/api/update_group', { phone: data.Ids, group_id: data.listGroupId }).then(res => {
        if (res.code == 0) {
            ElMessage.success('ÂàÜÁªÑËÆæÁΩÆÊàêÂäü')
            load()
        } else {
            ElMessage.error(res.msg)
        }
    })



}
//ÊâπÈáèÂàÜÁªÑ
const groupAll = () => {
    if (data.Ids.length == 0) {
        ElMessage.error('ËØ∑ÈÄâÊã©Ë¶ÅÂàÜÁªÑÁöÑË¥¶Âè∑')
        return
    }
    data.form.groupName_list = null
    data.listGroupId = null
    data.formGroup = true



}
const delAll = () => {
    if (data.Ids.length == 0) {
        ElMessage.error('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊï∞ÊçÆ')
        return
    }
    ElMessageBox.confirm('Âà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÔºåÁ°ÆÂÆöÂà†Èô§ÂêóÔºü', 'ÊèêÁ§∫', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
    }).then(() => {
        request.post('/api/delete_session', { phone: data.Ids }).then(res => {
            if (res.code == 0) {
                ElMessage.success('Âà†Èô§ÊàêÂäü')
                load()
            } else {
                ElMessage.error(res.msg)
            }
        })
        console.log("jinru")
    }).catch()
}


const batchUpdateOnline = (newStatus) => {
    if (data.Ids.length == 0) {
        ElMessage.error('ËØ∑ÈÄâÊã©Ë¶Å‰∏äÁ∫øÁöÑË¥¶Âè∑')
        return
    }
    // ÂâçÁ´ØÂÖàÊõ¥Êñ∞ UI Ë°®Ê†º‰∏≠ÁöÑ online Áä∂ÊÄÅ

    const phonenumber = []
    phonenumber.push(...data.Ids)
    console.log("ÊâπÈáè‰∏äÁ∫ø", phonenumber)
    if (newStatus == true) {
        request.post("/api/sign_in", { phone: phonenumber, proxy: "", server: 0 })
            .then(res => {

                load()

            }).catch(err => {
                console.error('Êé•Âè£ÂºÇÂ∏∏Ôºö', err);
                ElMessage.error('ÊúçÂä°Âô®ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
            });
        return
    }
    if (newStatus == false) {
        console.log("ÊâπÈáè‰∏ãÁ∫ø", phonenumber)
        request.post("/api/sign_out", { phone: phonenumber }).then(res => {
            load()
        })
    }



}
const importSuccess = (res) => {
    if (res.code == 200) {
        ElMessage.success('ÂØºÂÖ•ÊàêÂäü')
        load()
    } else {
        ElMessage.error(res.msg)
    }
}
</script>

<style scoped>
.upload-demo :deep(.el-upload-dragger) {
    padding: 0 !important
}

.el-upload__text {
    font-size: 10px;
}
</style>